{"version":3,"sources":["file:///Users/songxiangying/Library/Containers/com.tencent.xinWeChat/Data/Documents/xwechat_files/wxid_4kr9sthln3gq22_cb54/msg/file/2025-11/cc123/assets/core/Glass.ts"],"names":["_decorator","Color","Component","Node","Sprite","tween","UIOpacity","UITransform","Vec3","WaterColor","WaterColors","WaterSurface","ccclass","menu","property","Glass","type","tooltip","info","undefined","waters","isPickedUp","init","capNode","active","ad","reset","colors","updateDisplayState","waterCnt","length","i","setWater","waterNode","watersNode","children","resetSurface","waterSurface","showSurface","isSealed","putOnCap","updateShadowOpacity","adNode","shadowNode","opacityLevels","uiOpacity","getComponent","opacity","topIndex","topWaterNode","getTouchBoundingBoxToWorld","glassNode","getBoundingBoxToWorld","index","waterColor","black2color","None","hideCnt","Black","waterSprite","surfaceSprite","baseColor","base","surfaceColor","surface","to","color","start","putDown","glassTarget","position","x","z","shadowTarget","pickup","pickupHeight","hide","node","show","waterColorID","len","WHITE","pourOutWater","water","pop","addIntoWater","push","isAllHide","showHide","isAd","isFull","isEmpty","removeAd","randExchangeColors","sort","a","b","Math","random","toString","JSON","stringify"],"mappings":"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","sourcesContent":["/**\n * @Descripttion: 水瓶交互控制组件\n * @version: 1.1 (Safety Fixes)\n * @Author: Lioesquieu\n * @Date: 2025-07-20\n * @LastEditors: Lioesquieu\n * @LastEditTime: 2025-07-22\n */\nimport {_decorator, Color, Component, Node, Sprite, tween, UIOpacity, UITransform, Vec3} from 'cc';\nimport {WaterColor, WaterColors} from './CwgConstant';\nimport WaterSurface from './glass-anims/WaterSurface';\nimport { GlassInfo } from './FunlandInfo';\n\nconst {ccclass, menu, property} = _decorator;\n\n\n@ccclass('Glass')\n@menu('cwg/Glass')\nexport default class Glass extends Component {\n\n    @property({type: Node, tooltip: '瓶体碰撞节点（用于触摸检测）'})\n    protected glassNode: Node;\n\n    @property({type: Node, tooltip: '水层节点容器（包含4层水柱节点）'})\n    protected watersNode: Node;\n\n    @property({type: Node, tooltip: '密封状态瓶盖节点'})\n    protected capNode: Node;                // 瓶盖\n\n    @property\n    protected waterHeight: number = 40;          // 每节水柱的高度\n\n    @property\n    public pickupHeight: number = 32;\n\n    @property(Node)\n    public shadowNode: Node;\n\n    @property(WaterSurface)\n    protected waterSurface: WaterSurface;\n\n    @property(Node)\n    protected adNode: Node;\n\n    public info: GlassInfo = undefined;\n\n    protected waters: WaterColor[] = [];    // 水瓶内的水颜色\n\n    /** 标记瓶子是否处于拿起状态 */\n    public isPickedUp: boolean = false;\n\n    /**\n     * 初始化水瓶状态\n     * @param info\n     */\n    public init(info: GlassInfo) {\n        if (this.capNode) this.capNode.active = false;\n        \n        // 强制关闭广告\n        info.ad = false;\n\n        this.info = info;\n        this.reset(info.colors);\n        this.updateDisplayState();\n    }\n\n    /**\n     * 重置水柱显示状态\n     * @param waters 新的水色配置数组\n     */\n    public reset(waters: WaterColor[]) {\n        this.info.colors = waters;\n        this.waters = waters;\n        const waterCnt = waters.length;\n        for (let i = 0; i < waterCnt; i++) {\n            this.setWater(i, this.waters[i]);\n        }\n        for (let i = waterCnt; i < 4; i++) {\n            const waterNode = this.watersNode.children[i];\n            if (waterNode) waterNode.active = false;\n        }\n        this.resetSurface();\n    }\n\n    public resetSurface() {\n        this.waterSurface && this.waterSurface.reset();\n    }\n\n    /**\n     * 更新瓶子视觉状态\n     */\n    public updateDisplayState() {\n        this.showSurface();\n        if (this.isSealed()) {\n            this.putOnCap();\n        }\n        this.updateShadowOpacity();\n        \n        // 强制隐藏广告图标\n        if (this.adNode) {\n            this.adNode.active = false;\n        }\n    }\n\n    // 根据水多水少调整影子的颜色深浅\n    private updateShadowOpacity() {\n        // 【安全检查】确保 shadowNode 存在\n        if (!this.shadowNode) return;\n        \n        const opacityLevels = [64, 80, 96, 112, 128];\n        const uiOpacity = this.shadowNode.getComponent(UIOpacity);\n        // 【安全检查】确保组件存在\n        if (uiOpacity) {\n            uiOpacity.opacity = opacityLevels[this.waters.length];\n        }\n    }\n\n    // 每一层水都有一个水面，需要隐藏其他层的水面，显示最上层的水面\n    protected showSurface() {\n        const topIndex = this.waters.length - 1;\n        for (let i = 0; i < topIndex; i++) {\n            const waterNode = this.watersNode.children[i];\n            if (waterNode && waterNode.children[0]) waterNode.children[0].active = false;\n        }\n        if (topIndex >= 0) {\n            const topWaterNode = this.watersNode.children[topIndex];\n            if (topWaterNode && topWaterNode.children[0]) topWaterNode.children[0].active = true;\n        }\n    }\n\n    public getTouchBoundingBoxToWorld() {\n        if (!this.glassNode) return null;\n        return this.glassNode.getComponent(UITransform).getBoundingBoxToWorld();\n    }\n\n    /**\n     * 设置指定层水柱颜色\n     */\n    protected setWater(index: number, waterColor: WaterColor, black2color?: boolean) {\n        const waterNode = this.watersNode.children[index];\n        if (!waterNode) return; // 安全检查\n\n        if (waterColor == WaterColor.None) {\n            waterNode.active = false;\n            return;\n        }\n        if (index < this.info.hideCnt) {\n            waterColor = WaterColor.Black;\n            if (waterNode.children[1]) waterNode.children[1].active = true;\n        } else {\n            if (waterNode.children[1]) waterNode.children[1].active = false;\n        }\n        waterNode.active = true;\n        if (waterNode.children[0]) waterNode.children[0].active = false;\n        \n        const waterSprite = waterNode.getComponent(Sprite);\n        const surfaceSprite = waterNode.children[0]?.getComponent(Sprite);\n\n        if (!waterSprite || !surfaceSprite) return; // 安全检查\n\n        const baseColor = new Color(WaterColors[waterColor].base);\n        const surfaceColor = new Color(WaterColors[waterColor].surface);\n        if (black2color) {\n            tween(waterSprite).to(0.3, {color: baseColor}).start();\n            tween(surfaceSprite).to(0.3, {color: surfaceColor}).start();\n        } else {\n            waterSprite.color = baseColor;\n            surfaceSprite.color = surfaceColor;\n        }\n    }\n\n    // 把瓶子放下来\n    public putDown() {\n        if (!this.isPickedUp || !this.glassNode || !this.shadowNode) {\n            return;\n        }\n        this.isPickedUp = false;\n        \n        const glassTarget = new Vec3(this.glassNode.position.x, 0, this.glassNode.position.z);\n        tween(this.glassNode).to(0.17, { position: glassTarget }).start();\n\n        const shadowTarget = new Vec3(0, 0, this.shadowNode.position.z);\n        tween(this.shadowNode).to(0.17, { position: shadowTarget }).start();\n        \n        this.resetSurface();\n    }\n\n    // 把瓶子拿起来\n    public pickup() {\n        if (this.isPickedUp || !this.glassNode || !this.shadowNode) {\n            return;\n        }\n        this.isPickedUp = true;\n        \n        const glassTarget = new Vec3(this.glassNode.position.x, this.pickupHeight, this.glassNode.position.z);\n        tween(this.glassNode).to(0.17, { position: glassTarget }).start();\n\n        const shadowTarget = new Vec3(17.3, 10, this.shadowNode.position.z);\n        tween(this.shadowNode).to(0.17, { position: shadowTarget }).start();\n        \n        this.resetSurface();\n    }\n\n    public hide() {\n        this.node.active = false;\n    }\n\n    public show() {\n        if (this.node.active == false) {\n            this.node.active = true;\n            this.resetSurface();\n            return;\n        }\n        this.node.active = true;\n    }\n\n    /**\n     * 获取顶层水色\n     */\n    public get waterColorID(): WaterColor {\n        const len = this.waters.length;\n        if (len == 0) {\n            return 0;\n        }\n        return this.waters[len - 1];\n    }\n\n    public get waterColor(): Color {\n        const len = this.waters.length;\n        if (len == 0 || !this.watersNode.children[len - 1]) {\n            return Color.WHITE;\n        }\n        return this.watersNode.children[len - 1].children[0].getComponent(Sprite).color;\n    }\n\n    /**\n     * 倒出顶层水\n     */\n    public pourOutWater(): WaterColor {\n        const water = this.waters.pop();\n        const index = this.waters.length;\n        this.setWater(index, WaterColor.None);\n        this.resetSurface();\n        return water;\n    }\n\n    public addIntoWater(color: WaterColor) {\n        const index = this.waters.length;\n        this.waters.push(color);\n        this.setWater(index, color);\n        this.resetSurface();\n    }\n\n    public isAllHide() {\n        if (this.info.hideCnt <= 0) {\n            return false;\n        }\n        return this.info.hideCnt == this.waters.length;\n    }\n\n    public showHide() {\n        if (this.info.hideCnt <= 0) {\n            return;\n        }\n        this.info.hideCnt--;\n        this.setWater(this.info.hideCnt, this.waters[this.info.hideCnt], true);\n        this.updateDisplayState();\n    }\n\n    public isAd() {\n        return false;\n    }\n\n    /**\n     * 判断是否达到密封状态（4层同色水）\n     */\n    public isSealed() {\n        if (this.waters.length < 4) {\n            return false;\n        }\n        return this.waters[0] == this.waters[1] && this.waters[1] == this.waters[2] && this.waters[2] == this.waters[3];\n    }\n\n    public putOnCap() {\n        if(this.capNode) this.capNode.active = true;\n    }\n\n    public get isFull() {\n        return this.waters.length == 4;\n    }\n\n    public get isEmpty() {\n        return this.waters.length == 0;\n    }\n\n    public removeAd() {\n        this.info.ad = false;\n        this.updateDisplayState();\n    }\n\n    // 随机交换水颜色\n    public randExchangeColors() {\n        this.waters.sort((a, b) => {\n            return Math.random() - 0.5;\n        });\n        this.reset(this.waters);\n    }\n\n    public toString() {\n        return JSON.stringify({waters: this.waters});\n    }\n\n}"]}