{"version":3,"sources":["file:///Users/songxiangying/Library/Containers/com.tencent.xinWeChat/Data/Documents/xwechat_files/wxid_4kr9sthln3gq22_cb54/msg/file/2025-11/cc123/assets/core/VwFunland.ts"],"names":["_decorator","Component","Node","v3","CwgPools","Toolkit","EventMng","VwEffect","SoundComp","ccclass","menu","property","VwFunland","glasses","undoStack","undefined","finished","onLoad","console","log","reset","funland","glassesNode","removeAllChildren","i","len","length","glassInfo","glass","createGlass","push","scheduleOnce","forEach","resetSurface","pools","getGlass","init","cloneObj","glassNode","node","position","x","y","parent","active","playStart","setTouchListener","contentNode","targetOff","lastSelectedGlass","on","EventType","TOUCH_END","touch","currentSelected","handleTouchEnd","getUILocation","isValidSelection","putDown","isEmpty","isFull","handleWaterTransfer","pickup","location","find","index","box","getTouchBoundingBoxToWorld","contains","isSealed","source","target","waterColorID","playPourOutWater","checkWin","every","lastSelected","hide","info","colors","pourAnim","getPourOutAnim","effectView","flowAnim","getFlowingAnim","scale","transferredWaters","canTransferWater","water","pourOutWater","addIntoWater","updateDisplayState","worldPosition","flowingNode","pickupFromPosition","clone","add3f","pickUpMoveTo","pickupHeight","started","play","layerIdx","color","playWaterSound","complete","then","recycleFlowingAnim","show","putDownBack","recyclePourOutAnim","isAllHide","showHide","emit","soundComp","playPickup","handleRandExchangeColors","schedule","randExchangeColors","handleUndo","addEmptyGlass","addGlassInfo","sort","a","b"],"mappings":"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","sourcesContent":["/**\n * @Descripttion:\n * @version: 1.4 (Fix interaction bug)\n * @Author: Lioesquieu\n * @Date: 2025-07-20\n * @LastEditors: Lioesquieu\n * @LastEditTime: 2025-07-22\n */\nimport {_decorator, Component, EventTouch, Node, v3, Vec2} from 'cc';\nimport {CwgPools} from \"./CwgPools\";\nimport Glass from \"./Glass\";\nimport {WaterColor} from './CwgConstant';\nimport Toolkit from \"../common/Toolkit\";\nimport FunlandInfo, { GlassInfo } from './FunlandInfo';\nimport EventMng from '../common/EventMng';\nimport { VwEffect } from './VwEffect';\nimport SoundComp from './SoundComp';\n\nconst {ccclass, menu, property} = _decorator;\n\n@ccclass('VwFunland')\n@menu('cwg/VwFunland')\nexport class VwFunland extends Component {\n\n    @property(Node)\n    protected contentNode: Node;\n\n    @property(VwEffect)\n    protected effectView: VwEffect;\n\n    @property(CwgPools)\n    protected pools: CwgPools;\n\n    @property(Node)\n    protected glassesNode: Node;\n\n    @property(SoundComp)\n    protected soundComp: SoundComp;\n\n    public funland: FunlandInfo;\n\n    public glasses: Glass[] = [];\n\n    public undoStack: [Glass, WaterColor[]][] = undefined;\n\n    public finished: boolean = false;\n\n    protected onLoad() {\n        console.log(\"StVwFunland\")\n    }\n\n    // 初始化游乐场布局\n    public reset(funland: FunlandInfo) {\n        this.funland = funland;\n\n        this.glassesNode.removeAllChildren();\n        this.glasses = [];\n        \n        // 根据配置生成玻璃瓶阵列\n        for (let i = 0, len = funland.glasses.length; i < len; i++) {\n            const glassInfo = funland.glasses[i];\n            const glass = this.createGlass(glassInfo);\n            this.glasses.push(glass);\n        }\n        // 让水面显示出来\n        this.scheduleOnce(() => {\n            this.glasses.forEach(glass => {\n                glass.resetSurface();\n            })\n        }, 0.0);\n    }\n\n    protected createGlass(glassInfo: GlassInfo) {\n        // 从对象池获取玻璃瓶实例\n        const glass = this.pools.getGlass();\n        glass.init(Toolkit.cloneObj(glassInfo) as GlassInfo);\n\n        // 设置玻璃瓶位置并激活\n        const glassNode = glass.node;\n        \n        // y轴偏移 +100\n        glassNode.position = v3(glassInfo.position.x, glassInfo.position.y + 100, 0);\n        \n        glassNode.parent = this.glassesNode;\n        glassNode.active = true;\n\n        return glass;\n    }\n\n    // 开始游戏的方法\n    public playStart() {\n        this.setTouchListener();\n        this.finished = false;\n    }\n\n    // 触摸事件处理\n    protected setTouchListener() {\n        this.contentNode.targetOff(this);\n\n        let lastSelectedGlass: Glass = undefined;\n\n        // 注册触摸结束事件\n        this.contentNode.on(Node.EventType.TOUCH_END, (touch: EventTouch) => {\n            if (this.finished) {\n                return;\n            }\n\n            // 判断哪个瓶子被点击到了\n            const currentSelected = this.handleTouchEnd(touch.getUILocation());\n\n            // 有效性检查\n            if (!this.isValidSelection(currentSelected)) {\n                return;\n            }\n\n            // 处理重复点击同一玻璃瓶\n            if (lastSelectedGlass && currentSelected == lastSelectedGlass) {\n                lastSelectedGlass.putDown();\n                lastSelectedGlass = undefined;\n                return;\n            }\n\n            // 倒水逻辑处理\n            if (lastSelectedGlass && !lastSelectedGlass.isEmpty && !currentSelected.isFull) {\n                if (this.handleWaterTransfer(lastSelectedGlass, currentSelected)) {\n                    lastSelectedGlass = undefined;\n                    return;\n                }\n            }\n\n            // 更新选中状态\n            lastSelectedGlass?.putDown();\n            this.pickup(currentSelected);\n            lastSelectedGlass = currentSelected;\n        }, this);\n    }\n\n    private handleTouchEnd(location: Vec2) {\n        return this.glasses.find((glass, index) => {\n            const box = glass.getTouchBoundingBoxToWorld();\n            return box && box.contains(location);\n        });\n    }\n\n    private isValidSelection(glass: Glass) {\n        return glass?.node.active && !glass.isSealed();\n    }\n\n    private handleWaterTransfer(source: Glass, target: Glass) {\n        if (source.waterColorID === target.waterColorID || target.isEmpty) {\n            this.playPourOutWater(source, target);\n            return true;\n        }\n        return false;\n    }\n\n    // 判断是否通关\n    public checkWin() {\n        return this.glasses.every(glass => glass.isEmpty || glass.isSealed());\n    }\n\n    // 播放倒水动画并处理状态更新\n    protected playPourOutWater(lastSelected: Glass, currentSelected: Glass): void {\n        lastSelected.node.active = false;\n        currentSelected.hide();\n\n        const undoStack = [];\n        undoStack.push([lastSelected, [...lastSelected.info.colors]]);\n        undoStack.push([currentSelected, [...currentSelected.info.colors]]);\n        this.undoStack = undefined;\n\n        const pourAnim = this.pools.getPourOutAnim(lastSelected, this.effectView.node);\n        const flowAnim = this.pools.getFlowingAnim(currentSelected, this.glassesNode);\n\n        if (lastSelected.node.position.x > currentSelected.node.position.x) {\n            pourAnim.node.scale = v3(-1, 1, 1);\n        } else {\n            pourAnim.node.scale = v3(1, 1, 1);\n        }\n\n        const transferredWaters: WaterColor[] = [];\n        while (this.canTransferWater(lastSelected, currentSelected)) {\n            const water = lastSelected.pourOutWater();\n            currentSelected.addIntoWater(water);\n            transferredWaters.push(water);\n        }\n\n        lastSelected.updateDisplayState();\n        currentSelected.updateDisplayState();\n\n        const worldPosition = flowAnim.flowingNode.worldPosition;\n        const pickupFromPosition = lastSelected.node.worldPosition.clone().add3f(17, 220, 0);\n        pourAnim.pickUpMoveTo(pickupFromPosition.clone().add3f(0, lastSelected.pickupHeight, 0), worldPosition);\n\n        let started = false;\n        pourAnim.play(transferredWaters).on('startPour', (layerIdx: number, color: WaterColor) => {\n            flowAnim.play(color);\n            if (!started) {\n                started = true;\n                flowAnim.playWaterSound(transferredWaters.length);\n            }\n        }).on('completePour', async (layerIdx: number) => {\n            flowAnim.complete().then(() => {\n                this.pools.recycleFlowingAnim(flowAnim)\n                currentSelected.show();\n\n                if (currentSelected.isSealed()) {\n                    // 已注释掉特效\n                    // this.effectView.showFullSeled(currentSelected);\n                    this.undoStack = undefined;\n                } else {\n                    this.undoStack = undoStack;\n                }\n            })\n            pourAnim.putDownBack().then(() => {\n                this.pools.recyclePourOutAnim(pourAnim);\n                \n                // 确保原来的瓶子显示出来\n                lastSelected.node.active = true;\n\n                // 【修复点】取消了延时，立即执行放下动作。\n                // Glass.ts 里的安全检查会防止报错，同时保证状态立即同步。\n                lastSelected.putDown();\n                \n                this.scheduleOnce(() => {\n                    if (lastSelected.isAllHide()) {\n                        lastSelected.showHide();\n                    }\n                    EventMng.emit('completePour');\n\n                    if (this.checkWin()) {\n                        console.log(\"游戏通关！\");\n                        this.finished = true;\n                        // 延时缩短：0.1s\n                        this.scheduleOnce(() => {\n                            EventMng.emit('GameWin'); \n                        }, 0.1);\n                    }\n                }, 0.1);\n            })\n        });\n    }\n\n    private canTransferWater(source: Glass, target: Glass): boolean {\n        return !target.isFull && !source.isAllHide() &&\n            (source.waterColorID === target.waterColorID || target.isEmpty);\n    }\n\n    protected pickup(glass: Glass) {\n        this.soundComp.playPickup();\n        glass.pickup();\n    }\n\n    public handleRandExchangeColors(glass: Glass) {\n        this.schedule(() => {\n            glass.randExchangeColors();\n        }, 0.17, 8);\n    }\n\n    public handleUndo() {\n        if (!this.undoStack) {\n            return;\n        }\n        this.undoStack.forEach(([glass, colors]) => {\n            glass.reset(colors);\n        })\n        this.undoStack = undefined;\n    }\n\n    public addEmptyGlass(addGlassInfo: GlassInfo) {\n        console.log('addEmptyGlass')\n        if (addGlassInfo) {\n            this.funland.glasses.push(addGlassInfo);\n            this.funland.glasses.sort((a, b) => {\n                if (a.position.y != b.position.y) {\n                    return b.position.y - a.position.y;\n                }\n                return a.position.x - b.position.x;\n            })\n            const glass = this.createGlass(addGlassInfo);\n            this.glasses.push(glass);\n        }\n    }\n}"]}