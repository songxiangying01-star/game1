{"version":3,"sources":["file:///Users/songxiangying/Library/Containers/com.tencent.xinWeChat/Data/Documents/xwechat_files/wxid_4kr9sthln3gq22_cb54/msg/file/2025-11/cc123/assets/core/glass-anims/GlassFlowing.ts"],"names":["_decorator","Color","Node","Sprite","tween","UITransform","Toolkit","SoundComp","Glass","WaterColors","ccclass","menu","property","GlassFlowing","playWaterUpAnim","index","waterNode","watersNode","children","waterTransform","getComponent","height","flowingTf","flowingNode","by","waterHeight","start","waitForTween","to","playPutOnCapAnim","capNode","active","y","play","color","flowingSprite","fromHEX","base","startIdx","waters","length","flowingTransform","addIntoWater","complete","isSealed","playWaterSound","id","soundComp","playWater"],"mappings":"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","sourcesContent":["/**\n * @Descripttion:\n * 液体流动玻璃杯动画控制器\n * 处理液体注入和瓶盖动画的播放逻辑\n * @version: 1.2 (Safety Fixes & Speed Up)\n * @Author: Lioesquieu\n * @Date: 2025-07-20\n * @LastEditors: Lioesquieu\n * @LastEditTime: 2025-07-22\n */\nimport {_decorator, Color, Node, Sprite, tween, UITransform} from 'cc';\nimport Toolkit from '../../common/Toolkit';\nimport SoundComp from '../SoundComp';\nimport Glass from \"../Glass\";\nimport {WaterColor, WaterColors} from \"../CwgConstant\";\n\nconst {ccclass, menu, property} = _decorator;\n\n\n@ccclass('GlassFlowing')\n@menu('cwg/GlassFlowing')\nexport default class GlassFlowing extends Glass {\n\n    @property(Node)\n    public flowingNode: Node;\n\n    @property(SoundComp)\n    protected soundComp: SoundComp;\n\n    /**\n     * 播放水位上升动画\n     * @param index 水位索引（从0开始）\n     */\n    protected async playWaterUpAnim(index: number) {\n        const waterNode = this.watersNode.children[index];\n        \n        // 【关键修复】增加安全检查：如果水节点不存在（例如索引越界），直接返回，避免报错\n        if (!waterNode) {\n            // console.warn(\"尝试访问不存在的水位节点，索引:\", index);\n            return;\n        }\n\n        const waterTransform = waterNode.getComponent(UITransform);\n        // 【安全检查】确保组件存在\n        if (!waterTransform) return;\n\n        const height = waterTransform.height;\n        waterTransform.height = 46; // 初始高度设为46像素\n\n        // 水流根据水位高度变化\n        const flowingTf = this.flowingNode.getComponent(UITransform);\n        \n        // 速度加快：0.15s\n        tween(flowingTf).by(0.15, {height: -this.waterHeight}).start();\n\n        // 速度加快：0.15s\n        return Toolkit.waitForTween(tween(waterTransform).to(0.15, {height}));\n    }\n\n    /**\n     * 播放瓶盖盖合动画\n     */\n    public async playPutOnCapAnim() {\n        if (!this.capNode) return;\n        this.capNode.active = true;\n        this.capNode.y = 276;\n        // 盖盖子速度：0.2s\n        await Toolkit.waitForTween(tween(this.capNode).to(0.2, {y: 216}));\n    }\n\n    /**\n     * 主播放流程\n     * @param color 需要添加的新水颜色\n     */\n    public play(color: WaterColor) {\n\n        const flowingSprite = this.flowingNode.getComponent(Sprite);\n        if(flowingSprite) flowingSprite.color = new Color().fromHEX(WaterColors[color].base);\n\n        const startIdx = this.waters.length;\n\n        const flowingTransform = this.flowingNode.getComponent(UITransform);\n        if(flowingTransform) flowingTransform.height = 350 - 40 * startIdx; // 计算流动效果初始高度\n\n        // 激活流动效果节点\n        if(this.capNode) this.capNode.active = false;\n        this.flowingNode.active = true;\n\n        // 逐层添加新水并播放动画\n        this.addIntoWater(color);\n        this.playWaterUpAnim(startIdx)\n    }\n\n    // 添加水结束\n    public async complete() {\n        // 关闭流动效果\n        this.flowingNode.active = false;\n        if (this.isSealed()) {\n            await this.playPutOnCapAnim();\n        }\n    }\n\n    public playWaterSound(id: number): void {\n        // 播发倒水声音\n        if(this.soundComp) this.soundComp.playWater(id - 1);\n    }\n}"]}