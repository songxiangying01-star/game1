{"version":3,"sources":["file:///Users/songxiangying/Desktop/cc1234223/assets/core/VwPlay.ts"],"names":["_decorator","Component","director","VwFunland","VwUi","CwgState","FunlandInfo","EventMng","ccclass","menu","property","VwPlay","isSwitchingLevel","start","gameState","funland","init","off","handleGameWin","on","restartLevel","console","error","onDestroy","offTarget","log","scheduleOnce","performSwitchLevel","play","ui","reset","info","playStart","direction","preLevel","nextLevel","switchLevel","_","openLevelEditor","loadScene"],"mappings":"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","sourcesContent":["/**\n * @Descripttion:\n * @version: 1.7 (Level Switch Lock)\n * @Author: Lioesquieu\n * @Date: 2025-07-20\n * @LastEditors: Lioesquieu\n * @LastEditTime:2025-07-20\n */\nimport {_decorator, Component, director} from 'cc';\nimport {VwFunland} from \"./VwFunland\";\nimport {VwUi} from \"./VwUi\";\nimport CwgState from \"./CwgState\";\nimport FunlandInfo from './FunlandInfo';\nimport EventMng from '../common/EventMng';\n\nconst {ccclass, menu, property} = _decorator;\n\n@ccclass('VwPlay')\n@menu('cwg/VwPlay')\nexport class VwPlay extends Component {\n\n    @property(VwFunland)\n    protected play: VwFunland;\n\n    @property(VwUi)\n    protected ui: VwUi;\n\n    public funland: FunlandInfo;\n    public gameState: CwgState;\n\n    // 【新增】关卡切换锁，防止短时间内重复触发切换\n    private isSwitchingLevel: boolean = false;\n\n    start() {\n        this.gameState = new CwgState();\n        this.funland = new FunlandInfo();\n        \n        // 【安全检查】确保对象创建成功\n        if (this.funland && this.gameState) {\n            this.funland.init(this.gameState);\n\n            // 在注册之前先移除，防止重复注册\n            EventMng.off('GameWin', this.handleGameWin, this);\n            // 监听游戏通关事件\n            EventMng.on('GameWin', this.handleGameWin, this);\n\n            this.restartLevel();\n        } else {\n            console.error(\"游戏初始化失败：funland 或 gameState 为空！\");\n        }\n    }\n\n    protected onDestroy() {\n        EventMng.offTarget(this);\n    }\n\n    // 处理通关逻辑：自动进入下一关\n    protected handleGameWin() {\n        // 【关键修复】如果已经在切换关卡中，忽略后续的通关事件\n        if (this.isSwitchingLevel) {\n            console.log(\"正在切换关卡中，忽略重复的 GameWin 事件\");\n            return;\n        }\n\n        console.log(\"接收到通关事件，准备自动进入下一关\");\n        // 【关键修复】立即上锁\n        this.isSwitchingLevel = true;\n\n        // 自动通关延时：2.3秒\n        this.scheduleOnce(() => {\n            // 自动调用切换下一关逻辑（参数 '1' 代表下一关）\n            this.performSwitchLevel('1');\n        }, 2.3); \n    }\n\n    /**\n     * 重新开始当前关卡\n     * 重置游戏状态、关卡数据，并重新初始化视图\n     */\n    protected async restartLevel() {\n        // 【安全检查】防止对象为空导致报错\n        if (!this.gameState || !this.funland || !this.play || !this.ui) {\n            console.error(\"无法重启关卡：关键组件或数据丢失！\");\n            // 如果失败了也要解锁，否则游戏就卡死了\n            this.isSwitchingLevel = false;\n            return;\n        }\n\n        console.log(\"开始加载新关卡...\");\n        // 重置游戏状态\n        this.gameState.reset();\n        // 重置关卡数据\n        await this.funland.reset();\n\n        this.play.reset(this.funland);\n        this.ui.reset(this.gameState.info);\n\n        // 开始游戏\n        this.play.playStart();\n        \n        // 【关键修复】新关卡加载完成，解锁，允许下一次切换\n        this.isSwitchingLevel = false;\n        console.log(\"新关卡加载完成，切换锁解除\");\n    }\n\n    /**\n     * 执行切换关卡的实际逻辑\n     * @param direction 切换方向\n     */\n    private performSwitchLevel(direction: string) {\n        // 【安全检查】\n        if (!this.funland) {\n             this.isSwitchingLevel = false;\n             return;\n        }\n\n        if (direction == '-1') {\n            this.funland.preLevel();\n        } else {\n            this.funland.nextLevel();\n        }\n        this.restartLevel();\n    }\n\n    /**\n     * 切换到上一个或下一个关卡\n     * 这个方法通常绑定在 UI 按钮的 Click 事件上\n     * @param _ - 事件对象（未使用）\n     * @param direction - 切换方向，'-1'表示上一关，其他值表示下一关\n     */\n    protected switchLevel(_, direction: string) {\n        // 【关键修复】手动点击也要检查锁，防止和自动跳转冲突\n        if (this.isSwitchingLevel) {\n             console.log(\"正在切换中，忽略手动点击\");\n             return;\n        }\n        console.log(\"点击了切换关卡按钮，准备跳转\");\n        // 上锁\n        this.isSwitchingLevel = true;\n\n        // 手动点击按钮延时：1.0秒\n        this.scheduleOnce(() => {\n            this.performSwitchLevel(direction);\n        }, 0.6);\n    }\n\n    protected openLevelEditor() {\n        director.loadScene('editor');\n    }\n}"]}