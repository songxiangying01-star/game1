{"version":3,"sources":["file:///Users/songxiangying/Desktop/cc1234223/assets/core/VwUi.ts"],"names":["_decorator","Component","Label","Button","Sprite","director","VwFunland","EventMng","VwExchange","VwAddGlass","ccclass","menu","property","VwUi","_currLevelIndex","reset","info","level","levelLabel","string","toString","on","handleCompletePour","handleGameWin","exchangeView","node","active","onDestroy","offTarget","updateUndoDisplayState","console","log","scheduleOnce","loadScene","emit","undoButton","isValid","canUndo","funlandView","undoStack","length","interactable","sprite","getComponent","grayscale","handleProp","_","propName","show","handleUndo","addGlassView"],"mappings":"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","sourcesContent":["/**\n * @Descripttion:\n * @version: 1.1 (Added Scene Transition)\n * @Author: Lioesquieu\n */\nimport {_decorator, Component, Label, Button, Sprite, director} from 'cc'; // 1. 增加了 director 导入\nimport { CwgStateInfo } from './CwgState';\nimport { VwFunland } from './VwFunland';\nimport EventMng from '../common/EventMng';\nimport { VwExchange } from './prop-anims/VwExchange';\nimport { VwAddGlass } from './prop-anims/VwAddGlass';\n\nconst {ccclass, menu, property} = _decorator;\n\n@ccclass('VwUi')\n@menu('cwg/VwUi')\nexport class VwUi extends Component {\n\n    @property(Label)\n    protected levelLabel: Label;\n\n    @property(VwFunland)\n    protected funlandView: VwFunland;\n\n    @property(Button)\n    protected undoButton: Button;\n\n    @property(VwExchange)\n    protected exchangeView: VwExchange;\n\n    @property(VwAddGlass)\n    protected addGlassView: VwAddGlass;\n\n    // 新增变量：记录当前关卡索引\n    private _currLevelIndex: number = 0;\n\n    public reset(info: CwgStateInfo) {\n        // 记录当前关卡\n        this._currLevelIndex = info.level;\n\n        this.levelLabel.string = \"第\" + (info.level + 1).toString() + \"关\";\n        \n        // 监听倒水完成\n        EventMng.on('completePour', this.handleCompletePour, this);\n        \n        // 2. 新增：监听游戏胜利 (GameWin)\n        EventMng.on('GameWin', this.handleGameWin, this);\n\n        if (this.exchangeView) {\n            this.exchangeView.node.active = false;\n        }\n    }\n\n    protected onDestroy() {\n        EventMng.offTarget(this);\n    }\n\n    protected handleCompletePour() {\n        this.updateUndoDisplayState();\n    }\n\n    // 3. 新增：处理胜利逻辑\n    protected handleGameWin() {\n        // 判断：如果是第2关 (index >= 1)，跳转结尾页\n        if (this._currLevelIndex >= 1) {\n            console.log(\"全部通关，跳转到结尾页！\");\n            this.scheduleOnce(() => {\n                director.loadScene(\"End\");\n            }, 1.0); // 延迟1秒跳转\n        } else {\n            // 否则，通知 VwPlay 进入下一关\n            console.log(\"第1关通过，进入下一关\");\n            EventMng.emit('NextLevel');\n        }\n    }\n\n    // --- 下面是你原来的代码，完全没动 ---\n    protected updateUndoDisplayState() {\n        // 首先检查撤销按钮及其节点是否有效\n        if (!this.undoButton || !this.undoButton.node || !this.undoButton.node.isValid) {\n            return;\n        }\n\n        // 检查撤销栈是否存在且不为空\n        const canUndo = this.funlandView.undoStack && this.funlandView.undoStack.length > 0;\n        \n        this.undoButton.interactable = canUndo;\n\n        const sprite = this.undoButton.node.getComponent(Sprite);\n        if (sprite) {\n            sprite.grayscale = !canUndo;\n        }\n    }\n\n    protected handleProp(_, propName: string) {\n        if (propName === \"exchange\") {\n            this.exchangeView.show();\n        } else if (propName === \"undo\") {\n            this.funlandView.handleUndo();\n            this.updateUndoDisplayState();\n        } else if (propName === \"addEmptyGlass\") {\n            this.addGlassView.show();\n        }\n    }\n}"]}